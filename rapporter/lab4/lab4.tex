% !TEX TS-program = pdflatex
% !TEX encoding = UTF-8 Unicode

\documentclass[a4paper]{article}

\usepackage[swedish]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[pdftex]{graphicx}
\usepackage{float}
\usepackage{fancyhdr}


\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float


%%% HEADERS & FOOTERS
\author{Jonathan Karlsson, Niclas Olofsson, Paul Nedstrand\\jonka293, nicol271, paune\\Grupp 2}
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{1pt} % customise the layout...
\fancyhead[LO,LE]{Jonathan, Niclas, Paul\\Rapportmall}
\lfoot{}\cfoot{\thepage}\rfoot{}

%%%% SECTION TITLE APPEARANCE
%\usepackage{sectsty}
%\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
%% (This matches ConTeXt defaults)
%
%%%% ToC (table of contents) APPEARANCE
%\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
%\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
%\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
%\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

%%% END Article customizations

%%% The "real" document content comes below...

\title{Labrapport 4\\ \vspace{2 mm} {\large TSEA44}}
%\date{} % Activate to display a given date or no date (if empty),
         % otherwise the current date is printed

\begin{document}
\maketitle

\section{Inledning}
Det fjärde och sista miniprojektet i kursen, lab 4, handlar om att skapa en egen assembler-instruktion
för skrivning till minnet. Syftet med denna instruktion är att snabba upp koden för att
Huffman-koda den resulterade bilden från vår jpeg-accelerator.\\
Instruktionen tar en längd samt ett data som argument, och sparar all inkommen data
i en buffer tills minst 8 bitar erhållits. I detta fall skrivs den buffrade datan till minnet;
en byte åt gången och så många bytes som möjligt (maximalt två).


\section{Design}
\begin{itemize}
\item How does your hardware work?
\end{itemize}

\section{Resultat}
\subsection{Verifiering av hårdvarans funktion}
För att kontrollera att vår hårdvara fungerade, började vi med att anropa vår instruktion från det
montor-program som körs när datorn startar. Efter en del felsökning och justering övergick vi till att testa
koden på en FPGA med samma monitor-program. Vi använde monitorns inbyggda kommando för att visa minnesadresser
för att verifiera att rätt data skrevs till minnet. Ganska snabbt insåg vi behovet av att kunna felsöka
även i denna miljö utan att behöva syntetisera om koden varje gång, och skrev därför testprogrammet asm.c
som vi kunne ladda in i minnet och köra via monitorn.\\
Det största problem vi hade under denna lab, och även det svåraste vi fått under labkursen,
var att sista biten i varje byte vi skrev till minnet blev fel. Till skillnad från de tidigare fel
vi fått under kursen så fick vi varken några varningar av värde vid syntetiseringen, konstiga
odefinierade signaler eller märkliga läs/skrivcykler vid simulering.\\
Till sist testades även hårdvaran genom att instruktionen användes i jpegtest. jchuff.c modifierades,
för att använda set bit-instruktionen för skrivning till minnet, och en korrekt bild genererades.

\subsection{Prestanda och FPGA-användning}
Vi använde vårt testprogram och den prestandaräknare som inkluderades i jpegtest för att mäta prestandan på
några olika slags anrop till vår set bit-instruktion. Dels varierade vi storleken, dels testade vi
även att enbart skriva 0xFF, vilket i vår implementation gör två minnesskrivningar.\\

\begin{table}[ht]
    \centering
    \begin{tabular}{l l l}
        Storlek &  Data  &   Antal klockcykler\\
        \hline
        2       &  0x00  &   10\\
        8       &  0x00  &   13\\
        8       &  0xFF  &   17\\
        16      &  0x00  &   17\\
    \end{tabular}
    \caption{ Antal klockcykler för anrop av vår sbit-instruktion (medelvärde av 100 försök) }
    \label{tab:sbit_performance}
\end{table}

Vid användning i JPEG-acceleratorn jämförde vi utskriften av prestandamätningen för en version av
programmet som kompilerades utan set bit-instruktionen (\ref{tab:jpeg_sw_performance}), mot resultatet med denna instruktion påslagen (\ref{tab:jpeg_sbit_performance}).

\begin{table}[ht]
    \centering
    \begin{tabular}{l l}
        Beskrivning & Antal klockcykler\\
        \hline
        Main program  & 25 847 242 \\
        Init  &  6 600 044 \\
        Encode\_image  & 19 247 198 \\
        Forward\_DCT  & 6 489 189 \\
        Copy  & 0 \\
        DCT kernel  & 0 \\
        Quantization  & 6 489 189 \\
        Huffman encoding  & 12 226 950 \\
        Emit\_bits  &  4 983 905 \\
    \end{tabular}
    \caption{ Prestanda för jpegtest utan sbit-instruktionen }
    \label{tab:jpeg_sw_performance}
\end{table}

\begin{table}[ht]
    \centering
    \begin{tabular}{l l}
        Beskrivning & Antal klockcykler\\
        \hline
        Main program  & 21 754 287 \\
        Init  & 6 653 818 \\
        Encode\_image  & 15 100 469 \\
        Forward\_DCT  & 6 396 157 \\
        Copy  & 0 \\
        DCT kernel  & 0 \\
        Quantization  & 6 396 157 \\
        Huffman encoding  & 8 126 873 \\
        Emit\_bits  & 1 306 129 \\
    \end{tabular}
    \caption{ Prestanda för jpegtest med sbit-instruktionen }
    \label{tab:jpeg_sbit_performance}
\end{table}

% Lab 4
% Cycles spent in main program:             21754287
% +-- Cycles spent in init:                  6653818
% +-- Cycles spent in encode_image:         15100469
%     +-- Cycles spent in forward_DCT:       6396157
%     |   +-- Cycles spent in copy:                0
%     |   +-- Cycles spent in DCT kernel:          0
%     |   +-- Cycles spent in quantization:  6396157
%     +-- Cycles spent in Huffman encoding:  8126873
%         +-- Cycles spent in emit_bits:     1306129


100x size 2 = 1005
100x size 8 = 1305
100x size 16 = 1705
100x FF size 8 = 1704


% Lab 3
% Performance statistics:
% Cycles spent in main program:             25847242
% +-- Cycles spent in init:                  6600044
% +-- Cycles spent in encode_image:         19247198
%     +-- Cycles spent in forward_DCT:       6489189
%      |   +-- Cycles spent in copy:               0
%     |   +-- Cycles spent in DCT kernel:          0
%     |   +-- Cycles spent in quantization:  6489189
%     +-- Cycles spent in Huffman encoding: 12226950
%         +-- Cycles spent in emit_bits:     4983905


\begin{itemize}
%\item What is the performance with and without the set bit hardware? This should include measurements of both the entire application and the set bit instruction by itself, assuming good code in a software implementation (take a look at how the software solution in jpegfiles).
\item How much of the FPGA does your hardware use?
%\item What is the performance of your final system?
\end{itemize}

\section{Slutsats}


\section{Appendix: Källkod}


\section{What to Include in the Lab Report 4}
The lab report should contain all source code that you have written. (The source code should of course be commented.) We would also like you to include a block diagram of your hardware. If you have written any FSM you should include a state graph of the FSM.
We would also like you to discuss the following questions in detail somewhere in your lab report:
\begin{itemize}
%\item How did you verify that your set bit hardware worked?
%\item What was the hardest problems you encountered during the entire lab course?

\item How would your design change if you had to achieve even higher speed using more hardware?
\item How would your design change if you had to use less hardware at the cost of a slower solution?
\item What are the problems with using your new hardware in a multitasking operating system? How can the problem(s) be solved?

And of course, the normal parts of a lab report such as a table of contents, an introduction, a conclusion, etc. The source code that you have written should be included in appendices and referred to from the main document.

\end{itemize}


\end{document}
